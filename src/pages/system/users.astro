---
import type { DataResponse } from '@/types/Users';
import { ParamsSchema, DefaultParamsSchema } from '@/types/Users';
import { convertURLSearchParamsToObject } from '@/types/Utils';
import MainLayout from '@/layouts/MainLayout.astro';
import UsersPage from '@/components/pages/system/UsersPage.vue';

const hasAccess = Astro.locals.permissions?.includes('010100'); if (!hasAccess) { return Astro.redirect("/") }

const urlSearchParams = Astro.url.searchParams;
const params = convertURLSearchParamsToObject(urlSearchParams);
const safeParsedResult = ParamsSchema.safeParse(params);
const filters = safeParsedResult.success ? safeParsedResult.data : DefaultParamsSchema.parse({});
if (safeParsedResult.error) {
  Object.entries(filters).forEach(([key, value]) => value && urlSearchParams.set(key, value.toString()));
  return Astro.redirect(Astro.url.href);
}

const searchParams = new URLSearchParams(Object.fromEntries(Object.entries(filters).filter(([, value]) => value != null).map(([key, value]) => [key, String(value)])));
const apiOrigin = Astro.url.origin;
const url = new URL(`${apiOrigin}/api/system/users?${searchParams.toString()}`);
const res = await fetch(url.toString());
const response: DataResponse = await res.json();
---

<MainLayout>
  <UsersPage
    client:load
    filters={filters}
    data={response} />
</MainLayout>
